<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>„Ç∑„Éï„ÉàÁ∑®ÈõÜ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; margin: 0; }
    .header-bar {
      position: sticky; top: 0; background: white;
      padding: 10px 0; z-index: 20;
    }
    .table-wrapper {
      overflow: auto;
      max-height: 80vh;
    }
    table {
      border-collapse: collapse;
      width: max-content;
      min-width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
      white-space: nowrap;
    }
    th { background-color: #f0f0f0; z-index: 10; }
    th.sticky-left, td.sticky-left {
      position: sticky;
      left: 0;
      background-color: #fff;
      z-index: 15;
      min-width: 100px;
    }
    th.sticky-top {
      position: sticky;
      top: 0;
      z-index: 12;
    }
    td.sticky-top-second {
      position: sticky;
      top: 33px;
      background-color: #f9f9f9;
      z-index: 11;
    }
    .edit-cell {
      vertical-align: top;
      width: 170px;
      min-width: 170px;
      max-width: 170px;
      box-sizing: border-box;
      position: relative;
      /* È´ò„Åï„ÅØ„Ç§„É≥„É©„Ç§„É≥style„ÅßÂèØÂ§âÊåáÂÆö */
    }
    .view-mode, .edit {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      height: 100%;
    }
    .shift-block, .shift-line {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .edit input[type="time"] {
      width: 50px;
      height: 20px;
      font-size: 0.9em;
      margin: 0 2px;
      padding: 0 2px;
    }
    .setting-btn {
      margin-left: 8px;
      width: 28px;
      height: 28px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .setting-btn:hover { background: #0d47a1; }
    .shift-line { margin-bottom: 2px; font-size: 0.9em; }
    /* „É¢„Éº„ÉÄ„É´ */
    .modal-bg {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.3);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-bg.active { display: flex; }
    .modal-content {
      background: #fff;
      border-radius: 10px;
      padding: 24px 32px;
      min-width: 320px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.18);
      position: relative;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-shift-block { display: flex; align-items: center; margin-bottom: 8px; }
    .modal-shift-block input[type="time"] { width: 50px; height: 20px; margin: 0 4px; font-size: 0.9em; }
    .modal-delete-btn { margin-left: 8px; color: red; cursor: pointer; font-size: 16px; font-weight: bold; background: none; border: none; }
    .modal-add-btn { margin-top: 8px; color: #1976d2; cursor: pointer; font-size: 1em; background: none; border: none; }
    .modal-close-btn { position: absolute; top: 8px; right: 12px; font-size: 20px; color: #888; background: none; border: none; cursor: pointer; }
    .modal-save-btn { margin-top: 12px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 6px 18px; font-size: 1em; cursor: pointer; }
    .edit-cell.error {
      background-color: #ffcccc !important;
      border: 2px solid red;
    }
    .edit-cell.changed {
      background-color: #d0f0ff !important;
    }
    .mode-toggle { margin-right: 10px; }
    .group-separator td {
      background-color: #eef;
      font-weight: bold;
    }
    .group-label {
      text-align: left;
      padding-left: 8px;
    }
    .shift-line {
      margin-bottom: 2px;
    }
    .add-btn {
      margin-top: 4px;
      font-size: 0.8em;
      color: blue;
      cursor: pointer;
    }
    .delete-btn {
      margin-left: 4px;
      color: red;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <button class="mode-toggle" onclick="toggleEditMode()">Á∑®ÈõÜ„É¢„Éº„ÉâÂàáÊõø</button>
    <button type="submit" form="shiftForm">‰øùÂ≠ò</button>
    <a href="{{ url_for('admin.admin_home') }}" style="margin-left: 20px;">üè† „Éõ„Éº„É†„Å´Êàª„Çã</a>
    <a href="{{ url_for('admin.admin_edit') }}" style="margin-left: 10px;">üìÖ ÊúàÈÅ∏Êäû„Å´Êàª„Çã</a>
  </div>
  <div class="table-wrapper">
    <form id="shiftForm" method="post">
      <table>
        <thead>
          <tr>
            <th class="sticky-left sticky-top" rowspan="3">ÂêçÂâç</th>
            {% for d in date_labels %}
              <th class="sticky-top">{{ d.label }}</th>
            {% endfor %}
            <th class="sticky-top" rowspan="3">ÊúàÈñìÂêàË®à</th>
          </tr>
          <tr>
            {% for date in dates %}
              <td class="sticky-top-second">
                <input type="text" name="note_{{ date }}" value="{{ notes.get(date, '') }}" style="width: 80px; font-size: 12px;">
              </td>
            {% endfor %}
          </tr>
          <tr>
            {% for _ in dates %}
              <td class="sticky-top-second">Âä¥ÂÉçÊôÇÈñì</td>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for staff in staff_list %}
            {% if loop.index0 == 0 or staff.group != staff_list[loop.index0 - 1].group %}
              <tr class="group-separator">
                <td class="sticky-left group-label">‚ñº {{ group_name_map[staff.group] }}</td>
                <td colspan="{{ dates|length + 1 }}"></td>
              </tr>
            {% endif %}
            <tr>
              <td class="sticky-left">{{ staff.name }}</td>
              {% for date in dates %}
              <td class="edit-cell" data-name="{{ staff.name|replace(' ', '_') }}" data-date="{{ date }}"
                style="height:{{ (shifts.get(staff.name, {}).get(date, {})|length or 1) * 32 + 16 }}px; min-height:{{ (shifts.get(staff.name, {}).get(date, {})|length or 1) * 32 + 16 }}px; max-height:{{ (shifts.get(staff.name, {}).get(date, {})|length or 1) * 32 + 16 }}px;">
                <div class="view-mode">
                  {% set shift_dict = shifts.get(staff.name, {}).get(date, {}) %}
                  {% if shift_dict %}
                    {% for idx, shift in shift_dict.items() %}
                      <div class="shift-line">{{ shift[0] }}-{{ shift[1] }}</div>
                    {% endfor %}
                  {% else %}
                    <div class="shift-line">-</div>
                  {% endif %}
                </div>
                <div class="edit" style="display:none;">
                  {% set shift_dict = shifts.get(staff.name, {}).get(date, {}) %}
                  {% for idx in range(3) %}
                    {% set shift = shift_dict[idx] if shift_dict[idx] is defined else ('','') %}
                    <div class="shift-block" style="display:{{ 'flex' if idx < (shift_dict|length or 1) else 'none' }};">
                      <input type="time" name="start_{{ staff.name|replace(' ', '_') }}_{{ date }}_{{ idx }}" value="{{ shift[0] }}">
                      <input type="time" name="end_{{ staff.name|replace(' ', '_') }}_{{ date }}_{{ idx }}" value="{{ shift[1] }}">
                      {% if idx == 0 %}
                        <button type="button" class="setting-btn" onclick="openShiftModal('{{ staff.name|replace(' ', '_') }}','{{ date }}')">‚öôÔ∏è</button>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </td>
              {% endfor %}
              <td>
                {% if staff.type == 'Á§æÂì°' %}
                  {{ total_hours.get(staff.name, 0) | round(1) }}h
                {% endif %}
              </td>
            </tr>
            {% if staff.type == 'Á§æÂì°' %}
              <tr>
                <td class="sticky-left"></td>
                {% for date in dates %}
                  <td>
                    {% for shift in shifts.get(staff.name, {}).get(date, {}).values() %}
                      {{ calculate_shift_hours(shift[0], shift[1]) | round(1) }}h<br>
                    {% endfor %}
                  </td>
                {% endfor %}
                <td></td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </form>
  </div>
  <!-- „É¢„Éº„ÉÄ„É´Êú¨‰Ωì -->
  <div class="modal-bg" id="shiftModalBg">
    <div class="modal-content" id="shiftModalContent">
      <button class="modal-close-btn" onclick="closeShiftModal()">√ó</button>
      <h3>„Ç∑„Éï„ÉàË©≥Á¥∞Á∑®ÈõÜ</h3>
      <div id="modalShiftBlocks">
        <!-- JS„Åß„Ç∑„Éï„ÉàÂÖ•ÂäõÊ¨Ñ„ÇíÂãïÁöÑÁîüÊàê -->
      </div>
      <button class="modal-add-btn" onclick="addModalShiftBlock()">Ôºã„Ç∑„Éï„ÉàËøΩÂä†</button>
      <button class="modal-save-btn" onclick="saveModalShifts()">‰øùÂ≠ò</button>
    </div>
  </div>
  <script>
    function toggleEditMode() {
      const wrapper = document.querySelector('.table-wrapper');
      const scrollTop = wrapper.scrollTop;
      const scrollLeft = wrapper.scrollLeft;
      const cellWidth = 100;
      const rowHeight = 40;

      const centerColIndex = Math.round((scrollLeft + wrapper.clientWidth / 2) / cellWidth);
      const centerRowIndex = Math.round((scrollTop + wrapper.clientHeight / 2) / rowHeight);

      const allCells = document.querySelectorAll('.edit-cell');
      allCells.forEach(cell => {
        const view = cell.querySelector('.view-mode');
        const edit = cell.querySelector('.edit');
        const isEditMode = view.style.display === "none";
        view.style.display = isEditMode ? "block" : "none";
        edit.style.display = isEditMode ? "none" : "block";
      });

      setTimeout(() => {
        wrapper.scrollLeft = Math.max(0, centerColIndex * cellWidth - wrapper.clientWidth / 2);
        wrapper.scrollTop = Math.max(0, centerRowIndex * rowHeight - wrapper.clientHeight / 2);
      }, 0);
    }

    function addShift(name, date) {
      for (let i = 1; i <= 2; i++) {
        const selector = `.shift_${name}_${date}_${i}`;
        const block = document.querySelector(selector);
        if (block && block.style.display === "none") {
          block.style.display = "block";
          break;
        }
      }
    }

    function deleteShift(btn) {
      const inputs = btn.parentElement.querySelectorAll('input');
      inputs.forEach(input => input.value = '');
    }

    let currentModalName = '';
    let currentModalDate = '';
    function openShiftModal(name, date) {
      currentModalName = name;
      currentModalDate = date;
      // Êó¢Â≠ò„ÅÆÂÄ§„ÇíÂèñÂæó
      const blocks = [];
      for (let i = 0; i < 3; i++) {
        const start = document.querySelector(`input[name='start_${name}_${date}_${i}']`);
        const end = document.querySelector(`input[name='end_${name}_${date}_${i}']`);
        if (start && end && (start.value || end.value)) {
          blocks.push({start: start.value, end: end.value});
        }
      }
      renderModalShiftBlocks(blocks);
      document.getElementById('shiftModalBg').classList.add('active');
    }
    function closeShiftModal() {
      document.getElementById('shiftModalBg').classList.remove('active');
    }
    function renderModalShiftBlocks(blocks) {
      const container = document.getElementById('modalShiftBlocks');
      container.innerHTML = '';
      for (let i = 0; i < Math.max(blocks.length, 1); i++) {
        const block = document.createElement('div');
        block.className = 'modal-shift-block';
        block.innerHTML = `<input type='time' class='modal-start' value='${blocks[i]?.start || ''}'>
          <span style='margin:0 4px;'>-</span>
          <input type='time' class='modal-end' value='${blocks[i]?.end || ''}'>
          <button class='modal-delete-btn' onclick='deleteModalShiftBlock(this)'>√ó</button>`;
        container.appendChild(block);
      }
    }
    function addModalShiftBlock() {
      const container = document.getElementById('modalShiftBlocks');
      if (container.children.length >= 3) return;
      renderModalShiftBlocks([...getModalShiftBlocks(), {start:'', end:''}]);
    }
    function deleteModalShiftBlock(btn) {
      const container = document.getElementById('modalShiftBlocks');
      const idx = Array.from(container.children).indexOf(btn.parentElement);
      const blocks = getModalShiftBlocks();
      blocks.splice(idx, 1);
      renderModalShiftBlocks(blocks);
    }
    function getModalShiftBlocks() {
      const container = document.getElementById('modalShiftBlocks');
      return Array.from(container.children).map(block => ({
        start: block.querySelector('.modal-start').value,
        end: block.querySelector('.modal-end').value
      }));
    }
    function saveModalShifts() {
      const blocks = getModalShiftBlocks();
      for (let i = 0; i < 3; i++) {
        const startInput = document.querySelector(`input[name='start_${currentModalName}_${currentModalDate}_${i}']`);
        const endInput = document.querySelector(`input[name='end_${currentModalName}_${currentModalDate}_${i}']`);
        if (blocks[i]) {
          if (startInput) startInput.value = blocks[i].start;
          if (endInput) endInput.value = blocks[i].end;
        } else {
          if (startInput) startInput.value = '';
          if (endInput) endInput.value = '';
        }
      }
      closeShiftModal();
    }
  </script>
</body>
</html>